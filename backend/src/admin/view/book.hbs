{{#> layout }}
  <div class="row">
    <div class="col-3">
      <div class="card border-radius-lg">
        <div class="card-header p-3" style="background-color: transparent;">
          <img src="{{this.book.mainImage}}"/>
        </div>
      </div>
    </div>

    <div class="col-9">
      <div class="row h-100 flex-column flex-nowrap" style="gap: 24px">
        <div class="col-12">
          <div class="card">
            <div class="px-3 border-radius-lg pt-3 pb-3 d-flex justify-content-between align-items-center">
              <h6 class="text-capitalize" style="margin-bottom: 0px;">
                {{this.book.title}}
              </h6>
              <div class="d-flex" style="gap: 16px">
                 <button class="btn btn-outline-primary btn-sm mb-0" data-toggle="tooltip" data-bs-toggle="modal" data-bs-target="#update-image-model" data-toggle="tooltip"> 
                    <i class="fas fa-image text-sm"></i>&nbsp;&nbsp;Image
                  </button>
                 <button class="btn btn-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#update-form-modal" data-toggle="tooltip">
                    <i class="fas fa-pen text-sm"></i>&nbsp;&nbsp;Edit
                  </button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12" style="flex-grow: 1">
          <div class="card h-100">
            <div class="card-header pb-0 p-3">
              <div class="row">
                <div class="col-md-8 d-flex align-items-center">
                  <h6 class="mb-0">Description</h6>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <p class="text-sm">
                {{this.book.description}}
              </p>
              <ul class="list-group">
                <li class="list-group-item border-0 ps-0 pt-0 text-sm"><strong class="text-dark">Price:</strong> &nbsp; {{this.book.price}}$</li>
                <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Discount:</strong> &nbsp; {{this.book.discount}}%</li>
                <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Final Price:</strong> &nbsp; {{this.book.total}}$</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 mt-4">
      <div class="card">
        <div class="card-header pb-0 px-3">
          <div class="d-flex justify-content-between">
            <h6 class="mb-0">Authors</h6>
            <button class="btn btn-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-author-modal" data-toggle="tooltip">
              <i class="material-icons text-sm">add</i>&nbsp;&nbsp;Add
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Name</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Action</th>
                </tr>
              </thead>
              <tbody>
                 {{#each this.book.authors}}
                  <tr>
                    <td class="align-middle">
                      <span id="{{this.author.id}}" class="text-secondary text-xs font-weight-bold">{{this.author.name}}</span>
                    </td>
                    <td class="align-end">
                      <a class="btn btn-link btn-delete text-danger text-gradient px-3 mb-0" data-id="{{this.author.id}}" data-action="author"><i class="material-icons text-sm me-2">delete</i>Delete</a>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 mt-4">
      <div class="card">
        <div class="card-header pb-0 px-3">
          <div class="d-flex justify-content-between">
            <h6 class="mb-0">Categories</h6>
            <button class="btn btn-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-category-modal" data-toggle="tooltip">
              <i class="material-icons text-sm">add</i>&nbsp;&nbsp;Add
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Name</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Action</th>
                </tr>
              </thead>
              <tbody>
                 {{#each this.book.categories}}
                  <tr>
                    <td class="align-middle">
                      <span id="{{this.category.id}}" class="text-secondary text-xs font-weight-bold">{{this.category.name}}</span>
                    </td>
                    <td class="align-end">
                      <a class="btn btn-link btn-delete text-danger text-gradient px-3 mb-0" data-id="{{this.category.id}}" data-action="category" ><i class="material-icons text-sm me-2">delete</i>Delete</a>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>



    <div class="modal fade" id="update-form-modal" tabindex="-1" aria-labelledby="update-form-modal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Edit book</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="update-form" action="/admin/book/{{this.book.id}}/information" method="post">
              <div class="form-group">
                <input type="text" class="form-control mb-4" id="title" name="title" value="{{this.book.title}}" required="">
              </div>

              <div class="form-group">
                <label for="description">Description</label>
                <textarea type="text" style="height: 164px;" class="form-control mb-4" id="description" name="description" required="">{{this.book.description}}</textarea>
              </div>

              <div class="row">
                <div class="col-6">
                  <label for="price">Price</label>
                  <input type="number" class="form-control mb-4" id="price" name="price" value="{{this.book.price}}" required="">
                </div>

                <div class="col-6">
                  <label for="discount">Discount</label>
                  <input type="number" class="form-control mb-4" id="discount" name="discount" value="{{this.book.discount}}" required="">
                </div>
              </div>
              <button type="submit" class="btn btn-primary" >Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <div class="modal fade" id="update-image-model" tabindex="-1" aria-labelledby="update-image-model" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Edit image</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="update-image-form" action="/admin/book/{{this.book.id}}/image" method="post">
    
              <div class="mb-3">
                <input class="form-control" type="file" id="image" accept="image/png, image/gif, image/jpeg" required="">
              </div>

              <div class="d-flex justify-content-center">
                <img class="d-block mb-3 rounded" style="width: 128px;" id="image-preview" src="{{this.book.mainImage}}"/>
              </div>

              <button type="submit" class="btn btn-primary">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="add-author-modal" tabindex="-1" aria-labelledby="add-author-modal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Add author</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="add-author-form" action="/admin/book/{{this.book.id}}/author" method="post">
    
              <div class="input-group input-group-static mb-4">
                <label for="author" class="ms-0">Author</label>
                <select class="form-control" id="author" name="author">
                  {{#each this.authors}}
                    <option value="{{this.id}}">{{this.name}}</option>
                  {{/each}}
                </select>
              </div>

              <button type="submit" class="btn btn-primary" >Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="add-category-modal" tabindex="-1" aria-labelledby="add-category-modal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Add author</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="add-category-form" action="/admin/book/{{this.book.id}}/category" method="post">
    
              <div class="input-group input-group-static mb-4">
                <label for="author" class="ms-0">Category</label>
                <select class="form-control" id="category" name="category">
                  {{#each this.categories}}
                    <option value="{{this.id}}">{{this.name}}</option>
                  {{/each}}
                </select>
              </div>

              <button type="submit" class="btn btn-primary" >Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>
{{/layout}}

<script>
  $('#update-form').on('submit', function (e) {
    e.preventDefault();
    const url = $(this).attr('action');
    $.ajax({
      method: 'PATCH',
      url,
      data: $(this).serialize(),
      success: function (response) {
        window.location.href = '/admin/book/' + response.slug
      },
      error: function (error) {
        showToast('danger', "Unable to edit book")
      }
    })
  })

  $("#image").on('change', function () {
    const file = $(this)[0].files[0];
    const reader = new FileReader();
    reader.onload = function (e) {
      $('#image-preview').attr('src', e.target.result);
    }
    reader.readAsDataURL(file);
  })

  $('#update-image-form').on('submit', function(e) {
    e.preventDefault();
    const url = $(this).attr('action');
    const formData = new FormData();
    formData.append('image', $('#image')[0].files[0]);
    $.ajax({
      method: 'PATCH',
      url,
      data: formData,
      contentType: false,
      processData: false,
      success: function (response) {
        window.location.href = '/admin/book/' + response.slug
      },
      error: function (error) {
        showToast('danger', "Unable to edit book")
      }
    })
  })

  $('#add-category-form').on('submit', function (e) {
    e.preventDefault();
    const url = $(this).attr('action');
    $.ajax({
      method: 'POST',
      url,
      data: $(this).serialize(),
      success: function (response) {
        window.location.reload()
      },
      error: function (error) {
        showToast('danger', "Unable to add category")
      }
    })
  })

  $('#add-author-form').on('submit', function (e) {
    e.preventDefault();
    const url = $(this).attr('action');
    $.ajax({
      method: 'POST',
      url,
      data: $(this).serialize(),
      success: function (response) {
        window.location.reload()
      },
      error: function (error) {
        showToast('danger', "Unable to add author")
      }
    })
  })

  $('.btn-delete').on('click', function (e) {
    var id = $(this).data('id')
    var action = $(this).data('action')
    $.ajax({
      type: 'DELETE',
      url: `/admin/book/{{this.book.id}}/${action}/${id}`,
      success: function (response) {
        window.location.reload()
      },
      error: function () {
        showToast('danger', "Unable to delete category")
      }

    })
  })
</script>